<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
// vim:ft=javascript

var NEED_DROPPER_VERSION=1;
var BG_VERSION=1;

function $(id) {
    return document.getElementById(id);
}

var picker = {
  tab: 0,
  version: BG_VERSION,
  dropperLoaded: false,
  dropperVersion: 0,
  screenshotData: '',
  screenshotFormat: 'png',
  canvas: document.createElement("canvas"),
  canvasContext: null,
  debugImage: null,
  debugTab: 0,
  color: null,

  // use selected tab
  // need to null all tab-specific variables
  useTab: function(tab) {
    picker.tab = tab;
    picker.dropperLoaded = false;
    picker.dropperVersion = 0;
    picker.screenshotData = '';
    picker.canvas = document.createElement("canvas");
    picker.canvasContext = null;
    picker.color = null;

    picker.sendMessage({type: 'edropper-loaded'}, function(res) {
      picker.dropperLoaded = true; 
      picker.dropperVersion = res.version;
      console.log('Picker is loaded with version ' + picker.dropperVersion);
    });
  },

  sendMessage: function(message, callback) {
    chrome.tabs.sendRequest(picker.tab.id, message, callback);
  },

  messageListener: function() {
    console.log('message listener called');
    chrome.extension.onConnect.addListener(function(port) {
      port.onMessage.addListener(function(req) {
        switch(req.type) {
          // Taking screenshot for content script
          case 'screenshot': 
            console.log('received screenshot request');
            picker.capture(); break;
          
          // Creating debug tab
          case 'debug-tab': 
            picker.debugImage = req.image;
            picker.createDebugTab();
            break;

          // Define what background script supports
          case 'supports': picker.supports(req.what); break;

          // Set color given in req
          case 'set-color': picker.setColor(req); break;
                            
          // Get picked color
          case 'get-color': sendResponse({color: picker.color}); break;

          // Reload background script
          case 'reload-background': window.location.reload(); break;

          // Send empty response if unimplemented
          default: sendResponse({});
        }
      });
    });
  },

  supports: function(what) {
    var state = 'no';
    if ( req.what == 'dummy' || req.what == 'history' )
      state = 'ok';

    sendResponse({state: state});
  },

  setColor: function(req) {
    picker.color = req.color.rgbhex;
    chrome.browserAction.setBadgeText({text: 'N'});
    chrome.browserAction.setBadgeBackgroundColor({color: [req.color.r, req.color.g, req.color.b, 255]});

    if ( window.localStorage != null ) {
      // save to clipboard
      if ( window.localStorage['autoClipboard'] === "true" ) {
        var edCb = $('edClipboard');
        edCb.value = window.localStorage['autoClipboardNoGrid'] === "true" ? picker.color : '#' + picker.color; 
        edCb.select();
        document.execCommand("copy", false, null);
      }

      if ( req.history == undefined || req.history != 'no' ) {
        // add color to history
        var history = JSON.parse(window.localStorage.history);
        history.push(picker.color);
        window.localStorage.history = JSON.stringify(history);
      }
    }
  },

  // activate Pick
  activate: function() {
    // inject javascript if needed
    if ( picker.dropperLoaded === false ) {
      console.log('trying to inject jquery');
      chrome.tabs.executeScript(picker.tab.id, {file: "inc/jquery-1.4.2.min.js"}, function() {
        console.log('jquery injected');
        chrome.tabs.executeScript(picker.tab.id, {file: "inc/jquery-special-scroll.js"}, function() {
          console.log('jquery-special-scroll injected');
          chrome.tabs.executeScript(picker.tab.id, {file: "edropper2.js"}, function() {
            console.log('edropper2 injected');

            picker.pickupActivate();

          });
        });
      });
    // dropper is loaded but with old version
    } else if ( picker.dropperVersion < NEED_DROPPER_VERSION ) {
        chrome.tabs.executeScript(picker.tab.id, {file: "edropper2.js"}, function() {
          console.log('new version of edropper2 injected');

          picker.pickupActivate();

        });
    // dropper is loaded, activate
    } else
      picker.pickupActivate();
  },

  pickupActivate: function() {
    // activate picker
    picker.sendMessage({type: 'pickup-activate'}, function() {});
    console.log('activating pickup');
  },

  // capture actual Screenshot
  capture: function() {
    console.log('capturing');
    try {
      chrome.tabs.captureVisibleTab(null, {format: picker.screenshotFormat, quality: 100}, picker.doCapture);
    // fallback for chrome before 5.0.372.0
    } catch(e) {
      chrome.tabs.captureVisibleTab(null, picker.doCapture);
    }
  },

  doCapture: function(data) {
      console.log('sending updated image');
      picker.sendMessage({type: 'update-image', data: data}, function() {});
  },

  createDebugTab: function() {
    // DEBUG
    if ( picker.debugTab != 0 ) {
      chrome.tabs.sendRequest(picker.debugTab, {type: 'update'});
    } else
      chrome.tabs.create({url: 'debugimage.html', selected: false}, function(tab) { picker.debugTab = tab.id });
  },

  isThisPlatform: function(operationSystem) {
    return navigator.userAgent.toLowerCase().indexOf(operationSystem) > -1;
  },
  
  init: function() {
    // settings from local storage
    if ( window.localStorage.history == undefined )
      window.localStorage.history = "[]";
    // windows support jpeg only
    picker.screenshotFormat = picker.isThisPlatform('windows') ? 'jpeg' : 'png';

    // we have to listen for messages
    picker.messageListener();
  }
};

</script>
</head>
<body onload="picker.init()">
  <textarea id="edClipboard"></textarea>
</body>
</html>
