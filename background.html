<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
// vim:ft=javascript

function $(id) {
    return document.getElementById(id);
}

var picker = {
  tab: 0,
  screenshotData: '',
  screenshotFormat: 'png',
  canvas: document.createElement("canvas"),
  canvasContext: null,
  debugImage: null,
  debugTab: 0,
  rects: [],

  sendMessage: function(message, callback) {
    chrome.tabs.sendRequest(picker.tab.id, message, callback);
  },

  messageListener: function() {
    chrome.extension.onConnect.addListener(function(port) {
      port.onMessage.addListener(function(req) {
        if ( req.reqtype == 'screenshot' ) {
          picker.capture(req);
        } 
        console.log(req.reqtype);
      });
    });
  },

  // activate Pick
  activate: function() {
    picker.sendMessage({reqtype: 'pickup-activate'}, function() {});
    console.log('activating pickup');
  },

  checkCanvas: function(info) {
    // we have to create new canvas element
    if ( picker.canvas.width != (info.pageWidth+info.canvasBorders) || picker.canvas.height != (info.pageHeight+info.canvasBorders) ) {
      console.log('creating new canvas');
      picker.canvas = document.createElement('canvas');
      picker.canvas.width = info.pageWidth + info.canvasBorders;
      picker.canvas.height = info.pageHeight + info.canvasBorders;
      picker.canvasContext = picker.canvas.getContext('2d');
      picker.rects = [];
    }
  },

  // return true if rectangle A is whole in rectangle B
  rectInRect: function(A, B) {
    if ( A.x >= B.x && A.y >= B.y && (A.x+A.width) <= (B.x+B.width) && (A.y+A.height) <= (B.y+B.height) )
      return true;
    else
      return false;
  },

  // merge same x or y positioned rectangles if overlaps
  // width (or height)  of B has to be bigger or equal to A
  rectMerge: function(A, B) {
    if ( A.x == B.x && A.width <= B.width ) {
      if ( A.y < B.y ) {
        B.y = A.y;
        B.height = B.height + B.y - A.y;
      } else {
        B.height = B.height + A.y - B.y;
      }
      return B;

    } else if ( A.y == B.y && A.height <= B.height ) {
      if ( A.x < B.x ) {
        B.x = A.x;
        B.width = B.width + B.x - A.x;
      } else {
        B.width = B.width + A.x - B.x;
      }

      return B;
    }

    return false;
  },

  // capture actual Screenshot
  capture: function(info) {
    picker.checkCanvas(info);

    chrome.tabs.captureVisibleTab(null, {format: picker.screenshotFormat, quality: 100}, function(data) {
      var image = new Image();
      image.onload = function() {
        var rect = {x: info.pageXOffset, y: info.pageYOffset, width: image.width, height: image.height};
        var merged = false;

        // if there are already any rectangles
        if ( picker.rects.length > 0 ) {
          // if we already have this shot, return
          for ( index in picker.ects ) {
            if ( picker.rectInRect(rect, picker.rects[index]) )
            {
              screenshotTaken = true;
              return;
            }
          }

          // try to merge shot with others
          for ( index in picker.rects ) {
            var t = picker.rectMerge(rect, picker.rects[index]);

            if ( t != false ) {
              console.log('merging');
              merged = true;
              picker.rects[index] = t;
            }
          }
        }

        // put rectangle in array
        if (merged == false)
          picker.rects.push(rect);

        picker.canvasContext.drawImage(image, info.pageXOffset, info.pageYOffset);

        picker.sendMessage({reqtype: 'update-image', data: picker.canvas.toDataURL()}, function() {});

      }
      image.src = data;
      console.log('image data set');
    });
    // DEBUG
    if ( picker.debugTab != 0 ) {
      chrome.tabs.sendRequest(picker.debugTab, {reqtype: 'update'});
    } else
      chrome.tabs.create({url: 'debugimage.html', selected: false}, function(tab) { picker.debugTab = tab.id });
  },

  isThisPlatform: function(operationSystem) {
    return navigator.userAgent.toLowerCase().indexOf(operationSystem) > -1;
  },
  
  init: function() {
    // windows support jpeg only
    picker.screenshotFormat = picker.isThisPlatform('windows') ? 'jpeg' : 'png';

    // we have to listen for messages
    picker.messageListener();
  }
};

/*


*/

/*
var colorPicked = null;
var debug = false;

// initialize history
if ( window.localStorage.history == undefined )
  window.localStorage.history = "[]";

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if ( debug )
    console.log('received request: '+request.reqtype);

    // function for reporting what background supports
    if(request.reqtype == 'supports') {
      var state = 'no';

      if ( request.what == 'dummy' || request.what == 'history' )
        state = 'ok';

        sendResponse({state: state});

    } else if(request.reqtype == "get-shot") {
      try {
        chrome.tabs.captureVisibleTab(null, {format: 'png'}, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }
      catch (e) {
        chrome.tabs.captureVisibleTab(null, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }

    } else if(request.reqtype == "set-color") {
        colorPicked = request.color.rgbhex;
        chrome.browserAction.setBadgeText({text: 'N'});
        chrome.browserAction.setBadgeBackgroundColor({color: [request.color.r, request.color.g, request.color.b, 255]});

        if ( localStorage != null ) {
          // save to clipboard
          if ( window.localStorage['autoClipboard'] === "true" ) {
            var edCb = document.getElementById('edClipboard');
            edCb.value = window.localStorage['autoClipboardNoGrid'] === "true" ? colorPicked : '#'+colorPicked; 
            edCb.select();
            document.execCommand("copy", false, null);
          }

          if ( request.history == undefined || request.history != 'no' ) {
            // add color to history
            var history = JSON.parse(window.localStorage.history);
            history.push(colorPicked);
            window.localStorage.history = JSON.stringify(history);
          }
        }

        // send response
        sendResponse({text: colorPicked});

    } else if(request.reqtype == "get-color") {
        sendResponse({color: colorPicked});

        // handle debug tab
    } else if(request.reqtype == 'debug-image') {
      if ( request.data ) {
        img.show();
        img.src = request.data;
      }

        // reload background page
    } else if(request.reqtype == 'reload-background') {
      window.location.reload();

    } else
        sendResponse({});
});

$(document).ready(function() {
  var img = $("#debugImage");
  img.hide();
});
*/
</script>
</head>
<body>
  <textarea id="edClipboard"></textarea>
</body>
</html>
