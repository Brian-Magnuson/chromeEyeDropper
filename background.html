<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
// vim:ft=javascript

function $(id) {
    return document.getElementById(id);
}

var picker = {
  tab: 0,
  screenshotData: '',
  debugImage: null,

  sendMessage: function(message, callback) {
    chrome.tabs.sendRequest(picker.tab.id, message, callback);
  },

  messageListener: function() {
    chrome.extension.onConnect.addListener(function(port) {
      port.onMessage.addListener(function(req) {
          console.log(req.msg);
      });
    });
  },

  // activate Pick
  activate: function(test) {
    console.log('activating pickup');
    picker.capture();
  },

  // capture actual Screenshot and set screenshot Data
  capture: function() {
    try {
      chrome.tabs.captureVisibleTab(null, {format: 'png'}, picker.setScreenshotData);
    }
    catch (e) {
      chrome.tabs.captureVisibleTab(null, picker.setScreenshotData);
    }
  },
  // simply set data for taken screenshot
  setScreenshotData: function(data) {
    picker.screenshotData = data;
    picker.sendMessage({reqtype: 'pickup-activate'}, function() {});
    //chrome.tabs.create({'url': 'debugimage.html'}, function() {});
  },
  
  init: function() {
    // we have to listen for messages
    picker.messageListener();
  }
};

/*


*/

/*
var colorPicked = null;
var debug = false;

// initialize history
if ( window.localStorage.history == undefined )
  window.localStorage.history = "[]";

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if ( debug )
    console.log('received request: '+request.reqtype);

    // function for reporting what background supports
    if(request.reqtype == 'supports') {
      var state = 'no';

      if ( request.what == 'dummy' || request.what == 'history' )
        state = 'ok';

        sendResponse({state: state});

    } else if(request.reqtype == "get-shot") {
      try {
        chrome.tabs.captureVisibleTab(null, {format: 'png'}, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }
      catch (e) {
        chrome.tabs.captureVisibleTab(null, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }

    } else if(request.reqtype == "set-color") {
        colorPicked = request.color.rgbhex;
        chrome.browserAction.setBadgeText({text: 'N'});
        chrome.browserAction.setBadgeBackgroundColor({color: [request.color.r, request.color.g, request.color.b, 255]});

        if ( localStorage != null ) {
          // save to clipboard
          if ( window.localStorage['autoClipboard'] === "true" ) {
            var edCb = document.getElementById('edClipboard');
            edCb.value = window.localStorage['autoClipboardNoGrid'] === "true" ? colorPicked : '#'+colorPicked; 
            edCb.select();
            document.execCommand("copy", false, null);
          }

          if ( request.history == undefined || request.history != 'no' ) {
            // add color to history
            var history = JSON.parse(window.localStorage.history);
            history.push(colorPicked);
            window.localStorage.history = JSON.stringify(history);
          }
        }

        // send response
        sendResponse({text: colorPicked});

    } else if(request.reqtype == "get-color") {
        sendResponse({color: colorPicked});

        // handle debug tab
    } else if(request.reqtype == 'debug-image') {
      if ( request.data ) {
        img.show();
        img.src = request.data;
      }

        // reload background page
    } else if(request.reqtype == 'reload-background') {
      window.location.reload();

    } else
        sendResponse({});
});

$(document).ready(function() {
  var img = $("#debugImage");
  img.hide();
});
*/
</script>
</head>
<body>
  <textarea id="edClipboard"></textarea>
</body>
</html>
