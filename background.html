<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
// vim:ft=javascript

function $(id) {
    return document.getElementById(id);
}

var picker = {
  tab: 0,
  screenshotData: '',
  screenshotFormat: 'png',
  canvas: document.createElement("canvas"),
  debugImage: null,

  sendMessage: function(message, callback) {
    chrome.tabs.sendRequest(picker.tab.id, message, callback);
  },

  messageListener: function() {
    chrome.extension.onConnect.addListener(function(port) {
      port.onMessage.addListener(function(req) {
        if ( req.reqtype == 'screenshot' ) {
          picker.capture();
        } 
        console.log(req.reqtype);
      });
    });
  },

  // activate Pick
  activate: function() {
    console.log('activating pickup');
    picker.capture();
  },

  // capture actual Screenshot
  capture: function() {
    console.log('capturing');
    chrome.tabs.captureVisibleTab(null, {format: picker.screenshotFormat}, function(data) {
      var image = new Image();
      image.onload = function() {
        console.log('image loaded');
        picker.canvas.width = image.width;
        picker.canvas.height = image.height;

        var context = picker.canvas.getContext('2d');
        context.drawImage(image, 0, 0);

        picker.sendMessage({reqtype: 'update-image', data: picker.canvas.toDataURL()}, function() {});
        picker.sendMessage({reqtype: 'pickup-activate'}, function() {});
      }
      image.src = data;
      console.log('image data set');
    });
    // DEBUG
    //chrome.tabs.create({'url': 'debugimage.html'}, function() {});
  },

  isThisPlatform: function(operationSystem) {
    return navigator.userAgent.toLowerCase().indexOf(operationSystem) > -1;
  },
  
  init: function() {
    // windows support jpeg only
    picker.screenshotFormat = picker.isThisPlatform('windows') ? 'jpeg' : 'png';

    // we have to listen for messages
    picker.messageListener();
  }
};

/*


*/

/*
var colorPicked = null;
var debug = false;

// initialize history
if ( window.localStorage.history == undefined )
  window.localStorage.history = "[]";

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if ( debug )
    console.log('received request: '+request.reqtype);

    // function for reporting what background supports
    if(request.reqtype == 'supports') {
      var state = 'no';

      if ( request.what == 'dummy' || request.what == 'history' )
        state = 'ok';

        sendResponse({state: state});

    } else if(request.reqtype == "get-shot") {
      try {
        chrome.tabs.captureVisibleTab(null, {format: 'png'}, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }
      catch (e) {
        chrome.tabs.captureVisibleTab(null, function(dataURL) { 
          sendResponse({dataURL: dataURL})
        });
      }

    } else if(request.reqtype == "set-color") {
        colorPicked = request.color.rgbhex;
        chrome.browserAction.setBadgeText({text: 'N'});
        chrome.browserAction.setBadgeBackgroundColor({color: [request.color.r, request.color.g, request.color.b, 255]});

        if ( localStorage != null ) {
          // save to clipboard
          if ( window.localStorage['autoClipboard'] === "true" ) {
            var edCb = document.getElementById('edClipboard');
            edCb.value = window.localStorage['autoClipboardNoGrid'] === "true" ? colorPicked : '#'+colorPicked; 
            edCb.select();
            document.execCommand("copy", false, null);
          }

          if ( request.history == undefined || request.history != 'no' ) {
            // add color to history
            var history = JSON.parse(window.localStorage.history);
            history.push(colorPicked);
            window.localStorage.history = JSON.stringify(history);
          }
        }

        // send response
        sendResponse({text: colorPicked});

    } else if(request.reqtype == "get-color") {
        sendResponse({color: colorPicked});

        // handle debug tab
    } else if(request.reqtype == 'debug-image') {
      if ( request.data ) {
        img.show();
        img.src = request.data;
      }

        // reload background page
    } else if(request.reqtype == 'reload-background') {
      window.location.reload();

    } else
        sendResponse({});
});

$(document).ready(function() {
  var img = $("#debugImage");
  img.hide();
});
*/
</script>
</head>
<body>
  <textarea id="edClipboard"></textarea>
</body>
</html>
